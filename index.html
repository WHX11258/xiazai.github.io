<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>本地文件上传中心</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2eaadc',
            secondary: '#ff7d00',
            success: '#00b42a',
            danger: '#f53f3f',
            dark: '#1d2129',
            light: '#f2f3f5'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #2eaadc 0%, #0a66c2 100%);
      }
      .upload-shadow {
        box-shadow: 0 10px 30px rgba(46, 170, 220, 0.15);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(46, 170, 220, 0.2);
      }
    }
  </style>
</head>

<body class="font-inter bg-gray-50 text-dark">
  <!-- 导航栏 -->
  <header class="fixed top-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-sm shadow-sm transition-all duration-300">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <a href="#" class="flex items-center space-x-2">
            <i class="fa fa-cloud-upload text-primary text-2xl"></i>
            <span class="text-xl font-bold text-primary">本地文件上传中心</span>
          </a>
        </div>
        
        <nav class="hidden md:flex items-center space-x-8">
          <a href="#" class="text-gray-700 hover:text-primary transition-colors">首页</a>
          <a href="#upload" class="text-gray-700 hover:text-primary transition-colors">上传文件</a>
          <a href="#history" class="text-gray-700 hover:text-primary transition-colors">文件历史</a>
          <a href="#help" class="text-gray-700 hover:text-primary transition-colors">帮助指南</a>
        </nav>
        
        <div class="flex items-center">
          <button class="md:hidden text-gray-700 focus:outline-none" id="mobile-menu-button">
            <i class="fa fa-bars text-xl"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- 移动端菜单 -->
    <div class="md:hidden hidden bg-white border-t" id="mobile-menu">
      <div class="container mx-auto px-4 py-3 space-y-3">
        <a href="#" class="block text-gray-700 hover:text-primary transition-colors py-2">首页</a>
        <a href="#upload" class="block text-gray-700 hover:text-primary transition-colors py-2">上传文件</a>
        <a href="#history" class="block text-gray-700 hover:text-primary transition-colors py-2">文件历史</a>
        <a href="#help" class="block text-gray-700 hover:text-primary transition-colors py-2">帮助指南</a>
      </div>
    </div>
  </header>

  <!-- 主内容 -->
  <main class="pt-16">
    <!-- 英雄区域 -->
    <section class="gradient-bg text-white py-16 md:py-24">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto text-center">
          <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold leading-tight mb-6">
            简单高效的本地文件管理
          </h1>
          <p class="text-[clamp(1rem,2vw,1.25rem)] text-blue-100 mb-8">
            直接从你的电脑上传文件，在浏览器中管理和查看
          </p>
          <a href="#upload" class="inline-block px-8 py-3 bg-secondary text-white font-medium rounded-lg shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
            立即上传 <i class="fa fa-arrow-right ml-2"></i>
          </a>
        </div>
      </div>
    </section>

    <!-- 上传区域 -->
    <section id="upload" class="py-16 bg-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
          <div class="text-center mb-12">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark mb-4">上传你的文件</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">支持拖放上传或点击选择文件，文件将保存在浏览器本地存储中</p>
          </div>
          
          <!-- 上传区域 -->
          <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center upload-shadow bg-white transition-all duration-300 hover:border-primary/50">
            <div class="upload-icon mb-4">
              <i class="fa fa-cloud-upload text-5xl text-primary/70"></i>
            </div>
            <h3 class="text-xl font-medium mb-2">拖放文件到这里</h3>
            <p class="text-gray-500 mb-6">或者点击选择文件上传</p>
            <label class="inline-block px-6 py-3 bg-primary text-white font-medium rounded-lg cursor-pointer hover:bg-primary/90 transition-colors">
              <i class="fa fa-folder-open mr-2"></i>选择文件
              <input type="file" id="file-input" class="hidden" multiple>
            </label>
            <p class="text-xs text-gray-400 mt-4">支持所有文件类型，单个文件大小建议不超过100MB</p>
          </div>
          
          <!-- 上传进度区域 (默认隐藏) -->
          <div id="upload-progress" class="mt-8 hidden">
            <div class="flex justify-between items-center mb-2">
              <span id="file-name" class="font-medium"></span>
              <span id="progress-percentage" class="text-primary font-medium">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="flex justify-between items-center mt-2 text-sm text-gray-500">
              <span id="upload-speed">0 MB/s</span>
              <span id="upload-remaining">剩余时间: 计算中...</span>
            </div>
            <div class="mt-4 flex justify-end">
              <button id="cancel-upload" class="px-4 py-2 text-sm text-danger border border-danger rounded-lg hover:bg-danger/5 transition-colors">
                <i class="fa fa-times mr-1"></i> 取消上传
              </button>
            </div>
          </div>
          
          <!-- 上传设置 -->
          <div class="mt-8 bg-light rounded-xl p-6" id="upload-settings">
            <h3 class="text-lg font-medium mb-4 flex items-center">
              <i class="fa fa-cog text-primary mr-2"></i> 文件信息
            </h3>
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">文件名称</label>
                <input type="text" id="file-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="为你的文件命名">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">文件分类</label>
                <select id="file-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                  <option value="">选择分类</option>
                  <option value="document">文档</option>
                  <option value="image">图片</option>
                  <option value="video">视频</option>
                  <option value="audio">音频</option>
                  <option value="archive">压缩包</option>
                  <option value="other">其他</option>
                </select>
              </div>
              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">文件描述 (可选)</label>
                <textarea id="file-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all" placeholder="描述文件内容、用途等信息"></textarea>
              </div>
            </div>
            <div class="mt-4 flex justify-end">
              <button id="save-file" class="px-6 py-2 bg-primary text-white font-medium rounded-lg hover:bg-primary/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa fa-save mr-2"></i>保存文件
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- 文件历史 -->
    <section id="history" class="py-16 bg-gray-50">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-12">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark mb-4">文件历史</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">查看你上传的所有文件，这些文件存储在浏览器本地</p>
          </div>
          
          <!-- 无历史记录 -->
          <div id="no-history" class="hidden text-center p-12 bg-white rounded-xl">
            <i class="fa fa-folder-open-o text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">暂无上传文件</p>
            <a href="#upload" class="inline-block mt-4 px-4 py-2 text-sm text-primary border border-primary rounded-lg hover:bg-primary/5 transition-colors">
              <i class="fa fa-upload mr-1"></i> 上传新文件
            </a>
          </div>
          
          <!-- 搜索和筛选 -->
          <div id="history-controls" class="hidden mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="relative w-full md:w-64">
              <input type="text" id="history-search" placeholder="搜索文件..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
              <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
            <div class="flex items-center gap-3">
              <select id="history-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all">
                <option value="all">所有分类</option>
                <option value="document">文档</option>
                <option value="image">图片</option>
                <option value="video">视频</option>
                <option value="audio">音频</option>
                <option value="archive">压缩包</option>
                <option value="other">其他</option>
              </select>
              <button id="apply-filter" class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                <i class="fa fa-filter mr-1"></i> 筛选
              </button>
            </div>
          </div>
          
          <!-- 历史列表 -->
          <div id="history-list" class="hidden grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- 历史项目将通过JS动态生成 -->
          </div>
        </div>
      </div>
    </section>
    
    <!-- 帮助指南 -->
    <section id="help" class="py-16 bg-white">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto">
          <div class="text-center mb-12">
            <h2 class="text-[clamp(1.5rem,3vw,2.5rem)] font-bold text-dark mb-4">帮助指南</h2>
            <p class="text-gray-600 max-w-2xl mx-auto">解答你在使用过程中可能遇到的问题</p>
          </div>
          
          <div class="space-y-6">
            <!-- 问题 1 -->
            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <button class="w-full px-6 py-4 text-left font-medium flex justify-between items-center focus:outline-none help-question">
                <span>文件存储在哪里？</span>
                <i class="fa fa-chevron-down text-gray-400 transition-transform duration-300"></i>
              </button>
              <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 hidden help-answer">
                <p class="text-gray-600">所有上传的文件都存储在浏览器的本地存储中，仅在你的设备上可见。清除浏览器数据可能会导致文件丢失。</p>
              </div>
            </div>
            
            <!-- 问题 2 -->
            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <button class="w-full px-6 py-4 text-left font-medium flex justify-between items-center focus:outline-none help-question">
                <span>文件大小有限制吗？</span>
                <i class="fa fa-chevron-down text-gray-400 transition-transform duration-300"></i>
              </button>
              <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 hidden help-answer">
                <p class="text-gray-600">虽然技术上没有严格限制，但建议单个文件不超过100MB。较大的文件可能会导致浏览器性能问题，并且占用较多的存储空间。</p>
              </div>
            </div>
            
            <!-- 问题 3 -->
            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <button class="w-full px-6 py-4 text-left font-medium flex justify-between items-center focus:outline-none help-question">
                <span>如何在其他设备上访问我的文件？</span>
                <i class="fa fa-chevron-down text-gray-400 transition-transform duration-300"></i>
              </button>
              <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 hidden help-answer">
                <p class="text-gray-600">由于文件存储在本地浏览器中，它们不能直接在其他设备上访问。你需要通过"下载"功能将文件保存到你的设备，然后在其他设备上重新上传。</p>
              </div>
            </div>
            
            <!-- 问题 4 -->
            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <button class="w-full px-6 py-4 text-left font-medium flex justify-between items-center focus:outline-none help-question">
                <span>我的文件会保存多久？</span>
                <i class="fa fa-chevron-down text-gray-400 transition-transform duration-300"></i>
              </button>
              <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 hidden help-answer">
                <p class="text-gray-600">文件会一直保存在你的浏览器中，直到你手动删除它们或清除浏览器数据。建议定期将重要文件备份到你的设备。</p>
              </div>
            </div>
            
            <!-- 问题 5 -->
            <div class="border border-gray-200 rounded-xl overflow-hidden">
              <button class="w-full px-6 py-4 text-left font-medium flex justify-between items-center focus:outline-none help-question">
                <span>支持哪些文件类型？</span>
                <i class="fa fa-chevron-down text-gray-400 transition-transform duration-300"></i>
              </button>
              <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 hidden help-answer">
                <p class="text-gray-600">支持所有类型的文件上传。对于图片、文本和某些文档类型，可以直接在浏览器中预览。其他类型的文件可以下载到本地查看。</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 预览模态框 -->
  <div id="preview-modal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
    <div class="relative max-w-4xl w-full max-h-[90vh] overflow-auto bg-white rounded-xl">
      <button id="close-preview" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-black/10 rounded-full text-gray-700 hover:bg-black/20 z-10">
        <i class="fa fa-times"></i>
      </button>
      <div id="preview-content" class="p-4">
        <!-- 预览内容将动态生成 -->
      </div>
    </div>
  </div>

  <!-- 通知提示 -->
  <div id="notification" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center">
    <i id="notification-icon" class="mr-2 text-xl"></i>
    <span id="notification-message"></span>
  </div>

  <!-- 页脚 -->
  <footer class="bg-dark text-white py-12">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div>
          <div class="flex items-center space-x-2 mb-4">
            <i class="fa fa-cloud-upload text-primary text-2xl"></i>
            <span class="text-xl font-bold">本地文件上传中心</span>
          </div>
          <p class="text-gray-400 mb-4">一个简单的本地文件管理工具，让你可以直接在浏览器中上传、管理和查看文件。</p>
        </div>
        
        <div>
          <h3 class="text-lg font-medium mb-4">快速链接</h3>
          <ul class="space-y-2">
            <li><a href="#" class="text-gray-400 hover:text-white transition-colors">首页</a></li>
            <li><a href="#upload" class="text-gray-400 hover:text-white transition-colors">上传文件</a></li>
            <li><a href="#history" class="text-gray-400 hover:text-white transition-colors">文件历史</a></li>
            <li><a href="#help" class="text-gray-400 hover:text-white transition-colors">帮助指南</a></li>
          </ul>
        </div>
        
        <div>
          <h3 class="text-lg font-medium mb-4">注意事项</h3>
          <ul class="space-y-2">
            <li class="text-gray-400">文件存储在本地浏览器中</li>
            <li class="text-gray-400">清除浏览器数据会删除文件</li>
            <li class="text-gray-400">建议定期备份重要文件</li>
            <li class="text-gray-400">大文件可能影响性能</li>
          </ul>
        </div>
      </div>
      
      <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-500 text-sm">
        <p>&copy;  2025-9999 | 所有文件均存储在你的浏览器中</p>
      </div>
    </div>
  </footer>

  <!-- JavaScript -->
  <script>
    // DOM元素
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const fileNameElement = document.getElementById('file-name');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressPercentage = document.getElementById('progress-percentage');
    const uploadSpeed = document.getElementById('upload-speed');
    const uploadRemaining = document.getElementById('upload-remaining');
    const saveFileButton = document.getElementById('save-file');
    const cancelUploadButton = document.getElementById('cancel-upload');
    const fileNameInput = document.getElementById('file-name-input');
    const fileCategoryInput = document.getElementById('file-category');
    const fileDescriptionInput = document.getElementById('file-description');
    const helpQuestions = document.querySelectorAll('.help-question');
    const notification = document.getElementById('notification');
    const notificationIcon = document.getElementById('notification-icon');
    const notificationMessage = document.getElementById('notification-message');
    const noHistory = document.getElementById('no-history');
    const historyControls = document.getElementById('history-controls');
    const historyList = document.getElementById('history-list');
    const historySearch = document.getElementById('history-search');
    const historyFilter = document.getElementById('history-filter');
    const applyFilterBtn = document.getElementById('apply-filter');
    const previewModal = document.getElementById('preview-modal');
    const previewContent = document.getElementById('preview-content');
    const closePreview = document.getElementById('close-preview');
    
    // 状态变量
    let selectedFiles = [];
    let currentFileIndex = 0;
    let isUploading = false;
    let fileHistory = [];
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 从本地存储加载文件历史
      loadFileHistory();
      setupEventListeners();
    });
    
    // 从本地存储加载文件历史
    function loadFileHistory() {
      const savedFiles = localStorage.getItem('fileHistory');
      if (savedFiles) {
        try {
          fileHistory = JSON.parse(savedFiles);
          updateFileHistoryUI();
        } catch (e) {
          console.error('Failed to load file history:', e);
          fileHistory = [];
          localStorage.removeItem('fileHistory');
        }
      } else {
        fileHistory = [];
      }
      
      updateFileHistoryVisibility();
    }
    
    // 保存文件历史到本地存储
    function saveFileHistory() {
      try {
        localStorage.setItem('fileHistory', JSON.stringify(fileHistory));
      } catch (e) {
        console.error('Failed to save file history:', e);
        showNotification('保存文件失败，可能是存储空间不足', 'error');
      }
    }
    
    // 设置所有事件监听器
    function setupEventListeners() {
      // 移动端菜单切换
      mobileMenuButton.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
      });
      
      // 导航栏滚动效果
      window.addEventListener('scroll', () => {
        const header = document.querySelector('header');
        if (window.scrollY > 50) {
          header.classList.add('shadow');
          header.classList.remove('shadow-sm');
        } else {
          header.classList.remove('shadow');
          header.classList.add('shadow-sm');
        }
      });
      
      // 平滑滚动
      document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          e.preventDefault();
          
          const targetId = this.getAttribute('href');
          if (targetId === '#') return;
          
          const targetElement = document.querySelector(targetId);
          if (targetElement) {
            window.scrollTo({
              top: targetElement.offsetTop - 80,
              behavior: 'smooth'
            });
            
            // 关闭移动菜单
            if (!mobileMenu.classList.contains('hidden')) {
              mobileMenu.classList.add('hidden');
            }
          }
        });
      });
      
      // 拖放事件
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      
      ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });
      
      // 处理文件拖放
      dropArea.addEventListener('drop', handleDrop, false);
      
      // 处理文件选择
      fileInput.addEventListener('change', function() {
        if (this.files.length) {
          handleFiles(this.files);
        }
      });
      
      // 点击上传区域触发文件选择
      dropArea.addEventListener('click', function(e) {
        if (!e.target.closest('label') && !e.target.closest('input') && !isUploading) {
          fileInput.click();
        }
      });
      
      // 保存文件
      saveFileButton.addEventListener('click', startSavingFiles);
      
      // 取消上传
      cancelUploadButton.addEventListener('click', cancelUpload);
      
      // 帮助指南折叠面板
      helpQuestions.forEach(question => {
        question.addEventListener('click', () => {
          const answer = question.nextElementSibling;
          const icon = question.querySelector('i');
          
          answer.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        });
      });
      
      // 历史记录相关
      applyFilterBtn.addEventListener('click', applyFilters);
      historySearch.addEventListener('input', debounce(applyFilters, 500));
      historyFilter.addEventListener('change', applyFilters);
      
      // 预览模态框
      closePreview.addEventListener('click', closePreviewModal);
      previewModal.addEventListener('click', (e) => {
        if (e.target === previewModal) {
          closePreviewModal();
        }
      });
    }
    
    // 显示通知
    function showNotification(message, type = 'info') {
      // 设置通知内容和样式
      notificationMessage.textContent = message;
      
      // 设置图标和背景色
      notificationIcon.className = '';
      if (type === 'success') {
        notificationIcon.classList.add('fa', 'fa-check-circle', 'text-success');
        notification.classList.add('bg-success/10', 'text-success', 'border', 'border-success/30');
      } else if (type === 'error') {
        notificationIcon.classList.add('fa', 'fa-exclamation-circle', 'text-danger');
        notification.classList.add('bg-danger/10', 'text-danger', 'border', 'border-danger/30');
      } else {
        notificationIcon.classList.add('fa', 'fa-info-circle', 'text-primary');
        notification.classList.add('bg-primary/10', 'text-primary', 'border', 'border-primary/30');
      }
      
      // 显示通知
      notification.classList.remove('translate-y-20', 'opacity-0');
      notification.classList.add('translate-y-0', 'opacity-100');
      
      // 3秒后隐藏通知
      setTimeout(() => {
        notification.classList.remove('translate-y-0', 'opacity-100');
        notification.classList.add('translate-y-20', 'opacity-0');
        
        // 清除类以避免冲突
        setTimeout(() => {
          notification.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center';
        }, 300);
      }, 3000);
    }
    
    // 拖放辅助函数
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    function highlight() {
      dropArea.classList.add('border-primary');
      dropArea.classList.add('bg-primary/5');
    }
    
    function unhighlight() {
      dropArea.classList.remove('border-primary');
      dropArea.classList.remove('bg-primary/5');
    }
    
    // 处理文件拖放
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      
      if (files.length) {
        handleFiles(files);
      }
    }
    
    // 处理选中的文件
    function handleFiles(files) {
      // 转换为数组以便处理
      selectedFiles = Array.from(files);
      currentFileIndex = 0;
      
      // 检查文件大小 (建议不超过100MB)
      selectedFiles.forEach(file => {
        if (file.size > 100 * 1024 * 1024) {
          showNotification(`文件 ${file.name} 超过100MB，可能导致性能问题`, 'warning');
        }
      });
      
      // 如果有文件，显示第一个文件的信息
      if (selectedFiles.length > 0) {
        const firstFile = selectedFiles[0];
        fileNameElement.textContent = firstFile.name;
        fileNameInput.value = firstFile.name.replace(/\.[^/.]+$/, "");
        
        // 尝试根据文件扩展名设置分类
        const ext = firstFile.name.split('.').pop().toLowerCase();
        setCategoryByExtension(ext);
        
        // 显示上传进度区域
        uploadProgress.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        
        // 启用保存按钮
        saveFileButton.disabled = false;
      }
    }
    
    // 根据文件扩展名设置分类
    function setCategoryByExtension(ext) {
      const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp'];
      const videoExts = ['mp4', 'webm', 'mov', 'avi', 'mkv', 'flv'];
      const audioExts = ['mp3', 'wav', 'ogg', 'flac', 'aac'];
      const docExts = ['txt', 'pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'odt', 'ods', 'odp'];
      const archiveExts = ['zip', 'rar', '7z', 'tar', 'gz', 'bz2'];
      
      if (imageExts.includes(ext)) {
        fileCategoryInput.value = 'image';
      } else if (videoExts.includes(ext)) {
        fileCategoryInput.value = 'video';
      } else if (audioExts.includes(ext)) {
        fileCategoryInput.value = 'audio';
      } else if (docExts.includes(ext)) {
        fileCategoryInput.value = 'document';
      } else if (archiveExts.includes(ext)) {
        fileCategoryInput.value = 'archive';
      } else {
        fileCategoryInput.value = 'other';
      }
    }
    
    // 开始保存文件
    function startSavingFiles() {
      if (selectedFiles.length === 0) return;
      
      // 验证必填字段
      if (!fileNameInput.value.trim()) {
        showNotification('请输入文件名称', 'error');
        return;
      }
      
      // 禁用按钮
      saveFileButton.disabled = true;
      isUploading = true;
      
      // 开始处理当前文件
      processFile(selectedFiles[currentFileIndex]);
    }
    
    // 处理单个文件
    function processFile(file) {
      // 更新进度显示
      fileNameElement.textContent = file.name;
      progressBar.style.width = '0%';
      progressPercentage.textContent = '0%';
      
      const startTime = new Date().getTime();
      const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
      
      // 创建文件读取器
      const reader = new FileReader();
      
      // 模拟进度更新
      let progressInterval;
      
      reader.onloadstart = () => {
        // 模拟进度更新
        let progress = 0;
        progressInterval = setInterval(() => {
          // 实际项目中可以根据reader的进度来更新
          // 这里使用模拟进度
          progress += 5;
          if (progress > 95) progress = 95;
          
          progressBar.style.width = `${progress}%`;
          progressPercentage.textContent = `${progress}%`;
          
          // 计算上传速度和剩余时间
          const elapsedTime = (new Date().getTime() - startTime) / 1000; // 秒
          const uploadedMB = (progress / 100) * parseFloat(fileSizeMB);
          const speed = (uploadedMB / elapsedTime).toFixed(2);
          uploadSpeed.textContent = `${speed} MB/s`;
          
          // 计算剩余时间
          if (progress > 0) {
            const estimatedTotalTime = (elapsedTime / progress) * 100;
            const remainingTime = Math.max(0, estimatedTotalTime - elapsedTime);
            uploadRemaining.textContent = `剩余时间: ${formatTime(remainingTime)}`;
          }
        }, 200);
      };
      
      // 读取文件完成
      reader.onload = (e) => {
        clearInterval(progressInterval);
        
        // 创建文件对象
        const fileObj = {
          id: Date.now() + Math.floor(Math.random() * 1000), // 生成唯一ID
          name: fileNameInput.value.trim(),
          originalName: file.name,
          size: file.size,
          type: file.type,
          category: fileCategoryInput.value,
          description: fileDescriptionInput.value.trim(),
          content: e.target.result, // 文件内容 (base64)
          uploadDate: new Date().toISOString()
        };
        
        // 添加到文件历史
        fileHistory.unshift(fileObj); // 添加到开头
        saveFileHistory();
        
        // 更新进度为100%
        progressBar.style.width = '100%';
        progressPercentage.textContent = '100%';
        uploadRemaining.textContent = '处理完成';
        
        // 检查是否有更多文件
        currentFileIndex++;
        if (currentFileIndex < selectedFiles.length) {
          // 处理下一个文件
          setTimeout(() => {
            // 更新文件名输入
            const nextFile = selectedFiles[currentFileIndex];
            fileNameInput.value = nextFile.name.replace(/\.[^/.]+$/, "");
            
            // 尝试设置分类
            const ext = nextFile.name.split('.').pop().toLowerCase();
            setCategoryByExtension(ext);
            
            // 清空描述
            fileDescriptionInput.value = '';
            
            // 处理下一个文件
            processFile(nextFile);
          }, 1000);
        } else {
          // 所有文件处理完成
          setTimeout(() => {
            showNotification(`成功保存 ${selectedFiles.length} 个文件`, 'success');
            
            // 重置表单
            resetUploadArea();
            resetUploadForm();
            
            // 更新UI
            updateFileHistoryUI();
            updateFileHistoryVisibility();
            
            isUploading = false;
          }, 1000);
        }
      };
      
      // 读取文件错误
      reader.onerror = () => {
        clearInterval(progressInterval);
        showNotification(`文件 ${file.name} 处理失败`, 'error');
        console.error('File read error:', reader.error);
        
        isUploading = false;
        saveFileButton.disabled = false;
      };
      
      // 读取文件为base64
      if (file.size > 10 * 1024 * 1024) {
        // 大文件使用二进制字符串，减少内存占用
        reader.readAsBinaryString(file);
      } else {
        // 小文件使用DataURL (base64)
        reader.readAsDataURL(file);
      }
    }
    
    // 取消上传
    function cancelUpload() {
      // 重置上传状态
      selectedFiles = [];
      currentFileIndex = 0;
      isUploading = false;
      
      resetUploadArea();
      showNotification('上传已取消', 'info');
    }
    
    // 重置上传区域
    function resetUploadArea() {
      uploadProgress.classList.add('hidden');
      progressBar.style.width = '0%';
      progressPercentage.textContent = '0%';
      uploadSpeed.textContent = '0 MB/s';
      uploadRemaining.textContent = '剩余时间: 计算中...';
      saveFileButton.disabled = true;
      fileInput.value = '';
    }
    
    // 重置上传表单
    function resetUploadForm() {
      fileNameInput.value = '';
      fileCategoryInput.value = '';
      fileDescriptionInput.value = '';
    }
    
    // 格式化时间（秒 -> 分:秒）
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs < 10 ? '0' + secs : secs}`;
    }
    
    // 更新文件历史UI
    function updateFileHistoryUI() {
      // 应用当前筛选条件
      applyFilters();
    }
    
    // 更新文件历史可见性
    function updateFileHistoryVisibility() {
      if (fileHistory.length === 0) {
        noHistory.classList.remove('hidden');
        historyControls.classList.add('hidden');
        historyList.classList.add('hidden');
      } else {
        noHistory.classList.add('hidden');
        historyControls.classList.remove('hidden');
        historyList.classList.remove('hidden');
      }
    }
    
    // 添加文件到历史列表
    function addFileToHistoryList(file) {
      // 格式化文件大小
      let fileSize;
      if (file.size > 1024 * 1024) {
        fileSize = (file.size / (1024 * 1024)).toFixed(1) + ' MB';
      } else if (file.size > 1024) {
        fileSize = (file.size / 1024).toFixed(1) + ' KB';
      } else {
        fileSize = file.size + ' B';
      }
      
      // 格式化日期
      const date = new Date(file.uploadDate);
      const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
      
      // 获取文件图标
      let fileIcon = getFileIcon(file);
      
      // 创建历史项目元素
      const historyItem = document.createElement('div');
      historyItem.className = 'bg-white rounded-xl overflow-hidden shadow-md card-hover';
      historyItem.dataset.fileId = file.id;
      
      historyItem.innerHTML = `
        <div class="p-5">
          <div class="flex justify-between items-start mb-4">
            <div class="flex items-start">
              <div class="mr-3 text-2xl ${fileIcon.color}">${fileIcon.icon}</div>
              <div>
                <h3 class="font-semibold text-lg">${file.name}</h3>
                <p class="text-sm text-gray-500">${file.originalName}</p>
              </div>
            </div>
            <span class="px-2 py-1 text-xs font-medium ${getCategoryColor(file.category)} rounded-full">${getCategoryName(file.category)}</span>
          </div>
          <div class="flex items-center text-sm text-gray-500 mb-4">
            <span class="flex items-center mr-4"><i class="fa fa-calendar-o mr-1"></i> ${formattedDate}</span>
            <span class="flex items-center"><i class="fa fa-file-o mr-1"></i> ${fileSize}</span>
          </div>
          <div class="border-t border-gray-100 pt-4 flex justify-between items-center">
            <div class="flex gap-2">
              ${canPreviewFile(file) ? `
                <button class="p-2 text-gray-500 hover:text-primary transition-colors preview-file" title="预览" data-id="${file.id}">
                  <i class="fa fa-eye"></i>
                </button>
              ` : ''}
              <button class="p-2 text-gray-500 hover:text-primary transition-colors download-file" title="下载" data-id="${file.id}">
                <i class="fa fa-download"></i>
              </button>
            </div>
            <button class="p-2 text-gray-500 hover:text-danger transition-colors delete-file" title="删除" data-id="${file.id}">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      // 添加事件监听器
      if (canPreviewFile(file)) {
        historyItem.querySelector('.preview-file').addEventListener('click', () => {
          previewFile(file.id);
        });
      }
      
      historyItem.querySelector('.download-file').addEventListener('click', () => {
        downloadFile(file.id);
      });
      
      historyItem.querySelector('.delete-file').addEventListener('click', () => {
        deleteFile(file.id);
      });
      
      // 添加到列表
      historyList.appendChild(historyItem);
    }
    
    // 获取文件图标
    function getFileIcon(file) {
      const type = file.type.split('/')[0];
      const ext = file.originalName.split('.').pop().toLowerCase();
      
      switch (type) {
        case 'image':
          return { icon: '<i class="fa fa-file-image-o"></i>', color: 'text-green-500' };
        case 'video':
          return { icon: '<i class="fa fa-file-video-o"></i>', color: 'text-purple-500' };
        case 'audio':
          return { icon: '<i class="fa fa-file-audio-o"></i>', color: 'text-red-500' };
        case 'text':
          return { icon: '<i class="fa fa-file-text-o"></i>', color: 'text-blue-500' };
        default:
          if (['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext)) {
            return { icon: '<i class="fa fa-file-text-o"></i>', color: 'text-blue-500' };
          } else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
            return { icon: '<i class="fa fa-file-archive-o"></i>', color: 'text-yellow-500' };
          } else {
            return { icon: '<i class="fa fa-file-o"></i>', color: 'text-gray-500' };
          }
      }
    }
    
    // 获取分类名称
    function getCategoryName(category) {
      const categories = {
        'document': '文档',
        'image': '图片',
        'video': '视频',
        'audio': '音频',
        'archive': '压缩包',
        'other': '其他'
      };
      return categories[category] || '未分类';
    }
    
    // 获取分类颜色
    function getCategoryColor(category) {
      const colors = {
        'document': 'bg-blue-100 text-blue-800',
        'image': 'bg-green-100 text-green-800',
        'video': 'bg-purple-100 text-purple-800',
        'audio': 'bg-red-100 text-red-800',
        'archive': 'bg-yellow-100 text-yellow-800',
        'other': 'bg-gray-100 text-gray-800'
      };
      return colors[category] || 'bg-gray-100 text-gray-800';
    }
    
    // 检查文件是否可以预览
    function canPreviewFile(file) {
      const type = file.type.split('/')[0];
      const ext = file.originalName.split('.').pop().toLowerCase();
      
      // 可以预览的类型
      return type === 'image' || 
             type === 'video' || 
             type === 'audio' || 
             type === 'text' ||
             ext === 'pdf';
    }
    
    // 预览文件
    function previewFile(fileId) {
      const file = fileHistory.find(f => f.id === fileId);
      if (!file) return;
      
      previewContent.innerHTML = '';
      
      const type = file.type.split('/')[0];
      const ext = file.originalName.split('.').pop().toLowerCase();
      
      // 根据文件类型生成预览
      if (type === 'image') {
        previewContent.innerHTML = `
          <div class="flex justify-center">
            <img src="${file.content}" alt="${file.name}" class="max-w-full max-h-[70vh] object-contain">
          </div>
          <div class="mt-4">
            <h3 class="text-xl font-bold">${file.name}</h3>
            <p class="text-gray-600 mt-2">${file.description || '无描述'}</p>
          </div>
        `;
      } else if (type === 'video') {
        previewContent.innerHTML = `
          <div class="flex justify-center">
            <video controls class="max-w-full max-h-[70vh]">
              <source src="${file.content}" type="${file.type}">
              你的浏览器不支持视频预览
            </video>
          </div>
          <div class="mt-4">
            <h3 class="text-xl font-bold">${file.name}</h3>
            <p class="text-gray-600 mt-2">${file.description || '无描述'}</p>
          </div>
        `;
      } else if (type === 'audio') {
        previewContent.innerHTML = `
          <div class="flex justify-center">
            <audio controls class="w-full max-w-md">
              <source src="${file.content}" type="${file.type}">
              你的浏览器不支持音频预览
           </audio>
          </div>
          <div class="mt-4">
            <h3 class="text-xl font-bold">${file.name}</h3>
            <p class="text-gray-600 mt-2">${file.description || '无描述'}</p>
          </div>
        `;
      } else if (type === 'text' || ext === 'pdf') {
        if (ext === 'pdf') {
          previewContent.innerHTML = `
            <div class="flex justify-center">
              <embed src="${file.content}" type="application/pdf" width="100%" height="600px" />
            </div>
            <div class="mt-4">
              <h3 class="text-xl font-bold">${file.name}</h3>
              <p class="text-gray-600 mt-2">${file.description || '无描述'}</p>
            </div>
          `;
        } else {
          // 文本文件
          previewContent.innerHTML = `
            <div class="bg-gray-100 p-4 rounded-lg overflow-auto max-h-[70vh]">
              <pre class="whitespace-pre-wrap"><code>${escapeHtml(atob(file.content.split(',')[1]))}</code></pre>
            </div>
            <div class="mt-4">
              <h3 class="text-xl font-bold">${file.name}</h3>
              <p class="text-gray-600 mt-2">${file.description || '无描述'}</p>
            </div>
          `;
        }
      }
      
      // 显示预览模态框
      previewModal.classList.remove('hidden');
      previewModal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }
    
    // 关闭预览模态框
    function closePreviewModal() {
      previewModal.classList.add('hidden');
      previewModal.classList.remove('flex');
      document.body.style.overflow = '';
    }
    
    // 下载文件
    function downloadFile(fileId) {
      const file = fileHistory.find(f => f.id === fileId);
      if (!file) return;
      
      try {
        // 创建下载链接
        const a = document.createElement('a');
        a.href = file.content;
        a.download = file.originalName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        showNotification(`开始下载 ${file.name}`, 'success');
      } catch (e) {
        console.error('下载失败:', e);
        showNotification('文件下载失败', 'error');
      }
    }
    
    // 删除文件
    function deleteFile(fileId) {
      if (!confirm('确定要删除这个文件吗？此操作不可恢复。')) {
        return;
      }
      
      // 从数组中移除
      const index = fileHistory.findIndex(f => f.id === fileId);
      if (index !== -1) {
        fileHistory.splice(index, 1);
        saveFileHistory();
        
        // 从DOM中移除
        const element = document.querySelector(`[data-file-id="${fileId}"]`);
        if (element) {
          element.remove();
        }
        
        // 更新可见性
        updateFileHistoryVisibility();
        
        showNotification('文件已成功删除', 'success');
      }
    }
    
    // 应用筛选条件
    function applyFilters() {
      historyList.innerHTML = '';
      
      // 获取筛选条件
      const searchTerm = historySearch.value.trim().toLowerCase();
      const categoryFilter = historyFilter.value;
      
      // 应用筛选
      const filteredFiles = fileHistory.filter(file => {
        // 分类筛选
        if (categoryFilter && categoryFilter !== 'all' && file.category !== categoryFilter) {
          return false;
        }
        
        // 搜索筛选
        if (searchTerm && 
            !file.name.toLowerCase().includes(searchTerm) && 
            !file.originalName.toLowerCase().includes(searchTerm) &&
            !(file.description && file.description.toLowerCase().includes(searchTerm))) {
          return false;
        }
        
        return true;
      });
      
      // 更新列表
      if (filteredFiles.length > 0) {
        filteredFiles.forEach(file => {
          addFileToHistoryList(file);
        });
        historyList.classList.remove('hidden');
        noHistory.classList.add('hidden');
      } else {
        historyList.classList.add('hidden');
        noHistory.classList.remove('hidden');
      }
    }
    
    // 防抖函数
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
    
    // HTML转义函数
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
